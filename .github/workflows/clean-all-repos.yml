# .github/workflows/cleanup-simple.yml
name: è‡ªåŠ¨æ¸…ç†å·¥ä½œæµ
on:
  # æ¯æœˆ1å·å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ‰§è¡Œ
  schedule:
    - cron: '0 2 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      keep_minimum:
        description: 'æ¯ä¸ªå·¥ä½œæµä¿ç•™çš„è®°å½•æ•°'
        required: false
        default: '5'

permissions:
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Clean repositories one by one
        env:
          KEEP_MINIMUM: ${{ github.event.inputs.keep_minimum }}
        run: |
          # å®‰è£…å¿…è¦çš„å·¥å…·
          sudo apt-get update
          sudo apt-get install -y jq curl
          
          echo "å¼€å§‹æ¸…ç†å·¥ä½œæµè®°å½•..."
          echo "æ¯ä¸ªå·¥ä½œæµä¿ç•™ $KEEP_MINIMUM æ¡è®°å½•"
          echo ""
          
          # è·å–æ‰€æœ‰ä»“åº“
          page=1
          processed=0
          
          while true; do
            echo "è·å–ç¬¬ $page é¡µä»“åº“..."
            
            # ä½¿ç”¨ API è·å–ä»“åº“åˆ—è¡¨
            response=$(curl -s -H "Authorization: token ${{ secrets.OTHER_REPO_TOKEN }}" \
              "https://api.github.com/user/repos?per_page=100&page=$page&sort=updated")
            
            repos=$(echo "$response" | jq -r '.[].full_name')
            
            if [ -z "$repos" ] || [ "$repos" = "null" ]; then
              echo "æ²¡æœ‰æ›´å¤šä»“åº“äº†"
              break
            fi
            
            # å¤„ç†æ¯ä¸ªä»“åº“
            while IFS= read -r repo; do
              processed=$((processed + 1))
              echo "========================================"
              echo "[$processed] æ¸…ç†ä»“åº“: $repo"
              
              # ä½¿ç”¨ curl è°ƒç”¨ delete-workflow-runs çš„é€»è¾‘
              # è·å–å·¥ä½œæµåˆ—è¡¨
              workflows_response=$(curl -s -H "Authorization: token ${{ secrets.OTHER_REPO_TOKEN }}" \
                "https://api.github.com/repos/$repo/actions/workflows")
              
              workflow_ids=$(echo "$workflows_response" | jq -r '.workflows[].id // empty')
              
              if [ -z "$workflow_ids" ]; then
                echo "  è¯¥ä»“åº“æ²¡æœ‰å·¥ä½œæµæˆ–æ— è®¿é—®æƒé™"
                continue
              fi
              
              workflow_count=$(echo "$workflow_ids" | wc -l)
              echo "  æ‰¾åˆ° $workflow_count ä¸ªå·¥ä½œæµ"
              
              # å¤„ç†æ¯ä¸ªå·¥ä½œæµ
              deleted_total=0
              while IFS= read -r workflow_id; do
                # è·å–è¯¥å·¥ä½œæµçš„è¿è¡Œè®°å½•
                runs_response=$(curl -s -H "Authorization: token ${{ secrets.OTHER_REPO_TOKEN }}" \
                  "https://api.github.com/repos/$repo/actions/workflows/$workflow_id/runs?per_page=100")
                
                # æå–æ‰€æœ‰è¿è¡Œè®°å½•IDï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼‰
                run_data=$(echo "$runs_response" | jq -c '.workflow_runs | sort_by(.created_at) | reverse')
                run_count=$(echo "$run_data" | jq 'length')
                
                if [ $run_count -le $KEEP_MINIMUM ]; then
                  echo "    å·¥ä½œæµ $workflow_id: åªæœ‰ $run_count æ¡è®°å½•ï¼Œæ— éœ€æ¸…ç†"
                  continue
                fi
                
                echo "    å·¥ä½œæµ $workflow_id: $run_count æ¡è®°å½•ï¼Œä¿ç•™ $KEEP_MINIMUM æ¡"
                
                # è·å–è¦åˆ é™¤çš„è®°å½•IDï¼ˆä»ç¬¬ KEEP_MINIMUM+1 æ¡å¼€å§‹ï¼‰
                delete_ids=$(echo "$run_data" | jq -r ".[$KEEP_MINIMUM:][] | .id")
                delete_count=$(echo "$delete_ids" | wc -l)
                
                # åˆ é™¤æ—§è®°å½•
                deleted_in_workflow=0
                while IFS= read -r run_id; do
                  if [ -n "$run_id" ]; then
                    echo "      åˆ é™¤è¿è¡Œè®°å½•: $run_id"
                    curl -s -X DELETE -H "Authorization: token ${{ secrets.OTHER_REPO_TOKEN }}" \
                      "https://api.github.com/repos/$repo/actions/runs/$run_id" > /dev/null
                    deleted_in_workflow=$((deleted_in_workflow + 1))
                    deleted_total=$((deleted_total + 1))
                    sleep 0.3  # é¿å…é€Ÿç‡é™åˆ¶
                  fi
                done <<< "$delete_ids"
                
                echo "    åˆ é™¤äº† $deleted_in_workflow æ¡è®°å½•"
                
              done <<< "$workflow_ids"
              
              if [ $deleted_total -gt 0 ]; then
                echo "  âœ… æ€»å…±åˆ é™¤äº† $deleted_total æ¡è®°å½•"
              fi
              
              echo ""
              sleep 1  # é¿å…é€Ÿç‡é™åˆ¶
              
            done <<< "$repos"
            
            page=$((page + 1))
            
            # æœ€å¤šå¤„ç†3é¡µï¼ˆ300ä¸ªä»“åº“ï¼‰ï¼Œé¿å…è¶…æ—¶
            if [ $page -gt 3 ]; then
              echo "å·²è¾¾åˆ°æœ€å¤§å¤„ç†é¡µæ•°é™åˆ¶"
              break
            fi
            
          done
          
          echo "========================================"
          echo "ğŸ‰ æ¸…ç†å®Œæˆ!"
          echo "æ€»å…±å¤„ç†äº† $processed ä¸ªä»“åº“"
